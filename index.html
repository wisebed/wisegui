<!DOCTYPE html >
<meta charset="utf-8">
<head>
	<title>WISEBED REST/WebSocket API v2.3 - Home</title>
	<link rel="stylesheet" media="screen" href="css/bootstrap.css">
	<link rel="stylesheet" media="screen" href="css/wisebed-gui.css">
	<script type="text/javascript" src="js/jquery-1.7.1.js"></script>
	<script type="text/javascript" src="js/jquery.ba-bbq.min.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/bootstrap-dropdown-1.4.0.js"></script>
	<script type="text/javascript" src="js/wisebed.js"></script>
	<script type="text/javascript">

		function loadTestbedDetailsContainer(navigationData, parentDiv) {
			parentDiv.append($('<h1>Testbed Details '+navigationData.testbed+'</h1>'));
		}

		function loadExperimentContainer(navigationData, parentDiv) {
			parentDiv.append($('<h1>Experiment '+navigationData.testbed+' '+navigationData.experiment+'</h1>'));
		}

		function loadTestbedOverviewContainer(navigationData, parentDiv) {

			function fillTestbedOverviewTable(parentDiv) {
				Wisebed.getTestbeds(
						function(data){
							console.log(data);
							$.each(data.testbedMap, function(key, value) {
								var tr = $('<tr/>');
								var tdName = $('<td><a href="#nav=testbed&testbed='+key+'">'+value.name+'</a></td>');
								var tdUrnPrefixes = $('<td>'+value.urnPrefixes+'</td>');
								var tdSessionManagementEndpointUrl = $('<td>'+value.sessionManagementEndpointUrl+'</td>');
								tr.append(tdName, tdUrnPrefixes, tdSessionManagementEndpointUrl);
								parentDiv.children('.WisebedOverviewTable').append(tr);
							});

						},
						function(jqXHR, textStatus, errorThrown) {
							alert("Error while fetching testbed list: " + jqXHR.responseText);
						}
				);
			}

			$.ajax({
				url: "parts/testbed-overview.html",
				success: function(html) {
					parentDiv.html(html);
					fillTestbedOverviewTable(parentDiv);
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$('#WisebedContainer').html('<h1>Unable to load list of testbeds!</h1><h2>'+errorThrown+'</h2>');
				},
				context: document.body,
				dataType: "html"
			});
		}

		var appState = {
		};

		function getAppStateKey(nav, testbed, experiment) {
			if (nav == 'overview') {return 'overview'}
			if (nav == 'testbed' && experiment == '') {return 'testbed=' + testbed}
			if (nav == 'testbed' && experiment != '') {return 'testbed=' + testbed + '&experiment=' + experiment}
			return undefined;
		}

		function getCreateContentFunction(nav, testbed, experiment) {
			if (nav == 'overview') {return loadTestbedOverviewContainer}
			if (nav == 'testbed' && experiment == '') {return loadTestbedDetailsContainer}
			if (nav == 'testbed' && experiment != '') {return loadExperimentContainer}
			return undefined;
		}

		function loadNavigationBar(callbackDone) {
			$.ajax({
				url: "parts/navigation.html",
				success: function(html) {
					$('#WisebedContainer').append(html);
					callbackDone();
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$('#WisebedContainer').append('<h1>Application could not be loaded!</h1><br/><h2>Reason</h2>' + errorThrown + '<br/>' +jqXHR.responseText);
				},
				context: document.body,
				dataType: "html"
			});
		}

		function showReservationsDialog() {
			alert('TODO');
		}

		function showLoginDialog() {
			alert('TODO');
		}

		function adaptNavigationBar(navigationData) {

			var ul = $('#WisebedContainer div.WisebedNavigation ul.WisebedNavigationUl');

			if (navigationData.nav == 'overview') {

				ul.empty();
				ul.append('<li class="active"><a href="#nav=overview">Testbed Overview</a></li>');
			}
			else if (navigationData.nav == 'testbed') {

				ul.empty();

				ul.append('<li><a href="#nav=overview">Testbed Overview</a></li>');
				ul.append('<li>Running Experiments <select id="WisebedNavigationExperimentSelect" disabled="true"></select></li>');
				ul.append('<li><a href="javascript:showReservationsDialog()">Reservations</a></li>');


				if (Wisebed.hasSecretAuthenticationKeyCookie()) {
					var select = $('#WisebedNavigationExperimentSelect');
					select[0].disabled = false;
					fillWisebedNavigationExperimentSelect(select);

					ul.append('<li><a href="javascript:logout()">Logout</a></li>');
				} else {
					ul.append('<li><a href="javascript:showLoginDialog()">Login</a></li>');
				}
			}
		}

		function logout() {
			Wisebed.deleteSecretAuthenticationKeyCookie();
			document.location='#';
		}

		function fillWisebedNavigationExperimentSelect(select) {
			console.log('TODO fillWisebedNavigationExperimentSelect');
		}

		function onHashChange(e) {

			var nav = $.bbq.getState('nav') || 'overview';
			var testbed = $.bbq.getState('testbed') || '';
			var experiment = $.bbq.getState('experiment') || '';

			var appStateKey = getAppStateKey(nav, testbed, experiment);
			var createContentFunction = getCreateContentFunction(nav, testbed, experiment);
			var navigationData = {nav:nav, testbed:testbed, experiment:experiment};

			adaptNavigationBar(navigationData);

			console.log(navigationData);

			$('#WisebedContainer .WisebedContentContainer').children(':visible').hide();

			console.log("appStateKey=" + appStateKey);
			console.log("appState["+appStateKey+"]=" + appState[appStateKey]);

			if (appState[appStateKey]) {

				console.log("Loading container for: " + JSON.stringify(navigationData));
				$(appState[appStateKey]).show();

			} else {

				console.log("Creating container for: " + JSON.stringify(navigationData));

				var parentDiv = $('<div/>');
				$('#WisebedContainer .WisebedContentContainer').append(parentDiv);
				createContentFunction(navigationData, parentDiv);
				appState[appStateKey] = parentDiv;
				console.log(appState);
			}
		}

		$(function () {

			$('#WisebedContainer').append('<div class="WisebedContentContainer"/>');

			$(window).bind('hashchange', onHashChange);

			loadNavigationBar(function() {
				$(window).trigger('hashchange');
			});

			console.log("cookie:");
			console.log(document.cookie);
		});

	</script>
</head>
<body>

<div id="WisebedContainer" class="container">

</div>

</body>
</html>